# 1 网络基础
## 1.1 TCP/IP
TCP/IP是互联网相关的各类协议族的总称。包括TCP, IP, DNS, UDP, ...
### 1.1.1 应用层
各类通用的应用服务。如FTP, DNS, HTTP等。
### 1.1.2 传输层
提供网络中两台计算机的数据传输。包括TCP, UDP。
### 1.1.3 网路层
处理网络上流动的数据包。决定了传输路径。
### 1.1.4 链路层
处理链接网络的硬件部分。包含操作系统、网卡、光纤等。
## 1.2 传输流程
应用层（创建http报文） -> 传输层（加上TCP首部） -> 网络层（加上IP首部） -> 链路层（以太网首部）。  
发送端在分层传输过程，一层层加上首部，接收端接收后，每经过一层就去掉一个首部。

## 1.3 IP、TCP、DNS
### 1.3.1 IP协议
IP协议确保把各种数据包发送给对方，IP地址指明了节点的地址，MAC地址指明了网卡的固定地址。  
IP间的通信依赖MAC地址，当数据包在网络中中转时，目标IP地址是不会改变的，MAC地址会改变。  
使用ARP协议根据通信方的IP地址就可以反查出对应的MAC地址。  

### 1.3.2 TCP协议
TCP协议提供可靠的字节流服务，字节流服务指将大块数据分割成报文段为单位的数据包进行传输。  
为了可靠传输，TCP采用了三次握手策略：
1. 发送端发送带有SYN标志的数据包至接收端
2. 接收端收到后，回复带有SYN、ACK的数据包
3. 发送端回复带有ACK的数据包

### 1.3.3 DNS协议
DNS协议提供域名到IP地址的解析服务。  
用户通常使用域名来访问服务器，DNS协议提供通过域名查找IP地址的服务。

## 1.4 各种协议与HTTP协议的关系，以访问一个网站为例
发送端：  
首先通过DNS协议获取域名对应的IP地址；HTTP协议生成对目标资源的HTTP请求；TCP协议将请求报文分割成报文段，方便传输；IP协议提供中转、路由服务，在网络中传送数据包。   

接收端：
TCP协议将获取的报文段按序号重组；HTTP协议对请求的内容处理，生成对应资源的响应报文；响应报文同样经过TCP，IP协议回传给用户。  

## 1.5 URI和URL
### 1.5.1 统一资源标识符
URI是Uniform Resource Identifier的缩写。  
URI用字符串表示某一互联网资源，URL表示资源的站点，URL是URI的子集。  
URI的例子：  
ftp://ftp.a.com/b.txt    
http://www.c.org/d.txt

# 2 简单的HTTP协议
## 2.1 HTTP协议用于客户端和服务端之间的通信
在使用HTTP协议时，必定一方担任客户端角色，另一端担任服务端角色。
## 2.2 通过请求和响应的交换达成通信
HTTP协议规定，请求从客户端发出，最后服务端响应请求并返回，即肯定从客户端开始建立通信。
## 2.3 HTTP是无状态协议
HTTP协议自身不对请求和响应之间的通信状态进行保存，即对发送过的请求或响应都不做持久化处理。
## 2.4 请求URI定位资源
HTTP协议使用URI定位互联网上的资源，会在请求报文中指定请求URI。

## 2.5 告知服务器意图的HTTP方法
- GET 获取资源
- POST 将数据发送给服务器
- PUT 传输文件
- DELETE 删除文件
- HEAD 与GET类似，但只获取报文首部，不要主体
- OPTIONS 询问服务器支持的方法

## 2.6 持久连接节省通信量
在HTTP的初始版本中，每进行一次HTTP通信就要断开一次TCP连接。比如使用浏览器访问一个包含多张图片的HTML页面时，必须要进行多次通信，不断地建立、断开TCP连接。  
### 2.6.1 持久连接
HTTP1.1提出了持久连接，只要没有任意一端明确提出断开连接，则保持TCP连接状态。  
### 2.6.2 管线化
持久连接使管线化发送成为可能，即将多个HTTP请求整批提交的技术，无需等待服务端的响应。

## 2.7 使用Cookie的状态管理
无状态协议不保存状态，减少了服务器的压力，但是在使用中也会带来麻烦，如切换页面就需要重新登录的问题。  
Cookie技术通过在报文中写入Cookie信息来控制客户端的状态。  
服务端发送的响应报文内的Set-Cookie字段会通知客户端保存Cookie，下次客户端发送请求时，会自动在请求报文中加入Cookie后再发出。  
服务端发现请求中的Cookie后，通过对比服务器上的记录，就能得到对应客户端的状态信息。

# 3 HTTP报文内的HTTP信息
## 3.1 HTTP报文
HTTP报文可分为报文首部和报文主体。  
## 3.2 请求报文和响应报文
请求报文的首部第一行是请求行，包含请求方法，URI和HTTP版本。如 GET / HTTP/1.1  
响应报文的首部第一行是状态行，包含状态码，原因短语和HTTP版本。 如 HTTP/1.1 200 OK  
接下来就是表死各种属性和条件的各类首部。  
## 3.3 获取部分内容的范围请求
对于10000字节的资源，可以只请求5001~10000字节内的资源。  
执行范围请求时，使用首部字段Range来指定资源的byte范围。
```
Range: bytes=5001-10000
```
针对范围请求，服务器会返回206 Partial Content的响应报文；若无法处理范围请求，则返回200 OK和完整的实体内容。  
## 3.4 内容协商返回最合适的内容
根据浏览器的语言设置，访问相同的URI，会显示对应语言版本的页面。这样的机制称为内容协商（Content Negotiation）

# 4 返回结果的HTTP状态码
状态码告知从服务端返回的请求结果。状态码如200 OK，由3位数字和原因短语组成。
## 4.1 2xx 成功
### 4.1.1 200 OK
表示请求在服务端正常处理了。
### 4.1.2 204 No Content
请求成功，但是没有资源可返回。
### 4.1.3 206 Partial Content
客户端进行了范围请求，只返回部分资源。
## 4.2 3xx 重定向
### 4.2.1 301 Moved Permanently
永久重定向，表示请求的资源已被分配新的URI，以后应使用新的URI访问。
### 4.2.2 302 Found
表示请求的资源临时分配到新的URI，希望客户端本次使用新的URI访问。
### 4.2.3 303 See Other
与302类似，但服务器明确要求客户端使用GET请求。
### 4.2.4 304 Not Modified
客户端发送附带条件的请求（即GET请求报文中有If-Match等首部），服务器找到的资源不符合条件。
### 4.2.5 307 Temporary Redirect
临时重定向，与302一样。
## 4.3 4xx 客户端错误
### 4.3.1 400 Bad Request
请求报文中存在语法错误。
### 4.3.2 401 Unauthorized
发送的请求需要有通过HTTP认证（BASIC认证、DIGEST认证）的认证信息。
### 4.3.3 403 Forbidden
请求被服务器拒绝了。
### 4.3.4 404 Not Found
服务器上没有请求的资源。
## 4.4 5xx 服务器错误
### 4.4.1 500 Internal Server Error
服务端在执行请求时发生了错误。
### 4.4.2 503 Service Unavailable
服务器超负荷或停机维护，无法处理请求。

# 5 与HTTP协作的Web服务器
## 5.1 用单台虚拟机实现多个域名
访问不同的域名，DNS最终解析出的IP地址可能是同一个，这是因为虚拟主机（Virtual Host）可以寄存多个不同域名的网站。因此发送请求时要指定完整的URI。
## 5.2 通信数据转发程序：代理、隧道、网关
这些应用程序可以将请求转发给下一站，也能将响应再转发给客户端。
### 5.2.1 代理
代理有转发功能，是客户端和服务器间的"中间人"，接收请求转发给服务器，接收响应转发给客户端。  
代理不会改变请求的目标URI，而是直接转发。  
缓存代理可以减少对源服务器的请求，当接收到对已缓存的资源的请求时，可以直接响应。  
透明代理指不对报文进行任何加工的代理，反之，称为不透明代理。
### 5.2.2 网关
网关也是服务器，它接收到请求后，可以对请求进行处理，再转发给其他服务器。  
使用网管可以提升通信的安全性，可以在通信线路上加密以保证连接安全。
### 5.2.3 隧道
隧道在相隔很远的客户端、服务器间中转，是保持双方通信连接的应用程序。  
通信线路使用SSL等加密手段，隧道的目的是确保安全的通信。  
隧道本身不会解析请求，而是原样转发。  

## 5.3 对资源的缓存
缓存指在客户端或代理服务器保存对资源副本。利用缓存可减少对服务器的访问。  
### 5.3.1 缓存的有效期
即使存在缓存，也需要向源服务器确认缓存的有效性。若缓存失效，则缓存服务器应向源服务器获取新资源。
### 5.3.2 客户端的缓存
缓存可以存在于客户端的浏览器中，称为网络临时文件。同样，当判定缓存过期后，会向源服务器确认缓存的有效性。

# 6 HTTP首部
## 6.1 HTTP报文首部
请求和响应报文必须包含HTTP报文首部，首部包含了处理请求需要的信息。  
## 6.2 HTTP首部字段
### 6.2.1 HTTP首部字段传递重要信息
使用首部字段是为了提供报文主体大小、所使用的语言、认证信息等。
### 6.2.2 HTTP首部字段结构
首部字段由字段名和字段值组成，例如：
```
Content-Type: text/html
```
## 6.3 HTTP/1.1通用首部字段
通用首部字段指请求报文和响应报文双方都会使用的首部。
 - Cache-Control: 操作缓存的工作机制
 - Connect: 控制不转发给代理的字段；管理持久连接
 - Date：表明创建请求的时间
 - Transfer-Encoding：传输报文主体时使用的编码方式
 - Upgrade：检测是否能用更高版本的协议进行通信
 - Via：追踪请求的传输路径
 - Warning：告知用户一些与缓存相关的问题的警告

## 6.4 请求首部字段
 - Accept：通知服务器能够处理的文件类型及优先级
 - Accept-Charset：通知服务器能够处理的字符集类型及优先级
 - Accept-Encoding：通知服务器能够处理的内容编码（如gzip）及优先级
 - Accept-Language：通知服务器能够处理的语言类型及优先级
 - Authorization：客户端的认证信息
 - Expect：期望服务端出现的行为，如100-continue
 - From：客户端的电子邮件
 - Host：请求资源的主机名和端口号
 - If-Match：条件请求，告知服务器请求资源的实体标记值ETag，若与资源的Etag相同，则处理请求
 - If-None-Match：与If-Match相反
 - If-Modified-Since：若字段值早于资源的更新时间，则处理请求
 - If-Unmodified-Since：若字段值晚于资源的更新时间，则处理请求
 - If-Range：若字段值和ETag匹配，则执行范围请求，否则返回全部
 - Max-Forwards：往下转发的最大次数
 - Proxy-Authorization：客户端和代理之间的认证信息
 - Range：请求的范围
 - Referer：请求资源的原始URI，即请求的URI是从哪个页面发起的
 - TE：客户端能处理响应的编码方式和优先级
 - User-Agent：浏览器和用户代理信息

## 6.5 响应首部字段
 - Accept-Ranges：能否处理范围请求
 - Age：在多久前创建了响应
 - ETag：实体标识，资源更新后，这个值会改变
 - Location：重定向的位置
 - Proxy-Authenticate：代理服务器要求的认证信息
 - Retry-After：多久后才能再次发送请求
 - Server：服务器的应用程序信息
## 6.6 实体首部字段
 - Allow：通知客户端支持的方法
 - Content-Encoding：编码方式
 - Content-Language：资源语言
 - Content-Length：资源长度
 - Content-Location：资源URI
 - Content-MD5：资源经MD5算法生成的值，用于验证完整性
 - Content-Range：返回实体的范围
 - Content-Type：实体的文件类型
 - Expires：资源失效日期
 - Last-Modified：资源上次修改时间

## 6.7 为Cookie服务的首部字段
 - Set-Cookie：位于响应报文，告知Cookie的相关信息
 - Cookie：位于请求报文，告知服务端，客户端发送请求时会包含Cookie信息

# 7 确保Web安全的HTTPS
## 7.1 Http的缺点
 - 通信使用明文，可能会被窃听
 - 不验证通信方的身份，可能遭遇伪装
 - 无法验证报文完整性，可能遭遇篡改
## 7.2 HTTP + 加密 + 认证 + 完整性保护 = HTTPS
### 7.2.1
添加了加密和认证机制的HTTP被称为HTTPS，使用HTTPS时，地址改用https://。
### 7.2.2 HTTPS是身披SSL外壳的HTTP
通常，HTTP直接和TCP通信，HTTPS就是在他们之间加了一层SSL(Secure Socket Layer)
### 7.2.3 加密技术
#### 共享加密
加密、解密用同一个密钥的方式称为共享密钥加密。以这种方式加密时，必须将密钥发给对方，这个过程存在风险。
#### 公开密钥加密
使用两把非对称的钥匙，一把私有密钥，一把公有密钥。私有密钥不公开，公开密钥随意发布。  
发送密文的一方使用公开密钥加密，对方收到后再用私有密钥解密。
#### HTTPS使用混合加密
公开密钥加密虽然安全，但是处理速度慢。  
HTTPS首先使用公开密钥加密的方式交换在稍后共享加密中用到的密钥，随后使用共享加密的方式进行通信。
### 7.2.4 证书
为确保公开密钥是货真价实的，需要第三方认证机构颁发的证书，服务器会把公钥证书发给客户端，客户端通过对证书签名来验证公钥的真实性。
## 为什么不一直使用HTTPS?
 - 加密通信消耗更多的CPU及内存资源，因此只有在包含个人敏感信息时，才使用HTTPS
 - 使用HTTPS证书是必须的，而证书是收费的

# 8 确认访问用户身份的认证
## 8.1 何为认证
核对信息，以确认对方的身份。  
HTTP/1.1使用的认证方式：
 - BASIC认证：基本认证
 - DIGEST认证：摘要认证
 - SSL客户端认证
 - FormBase认证：基于表单认证
## 8.2 BASIC认证
1. 客户端发送请求
2. 服务端返回401响应，要求客户端进行认证
3. 客户端以用户ID和密码进行Base64编码处理后随请求发送给服务端
4. 认证成功则返回200，不成功则返回201
BASIC认证被解码后就是用户名和米阿么，安全性不高，所以不常用。
## 8.3 DIGEST认证
DIGEST认证在BASIC认证的基础上，服务端在返回401响应时，会同时返回一个质询码，客户端回复摘要及由质询码计算出的响应码来进行认证。
## 8.4 SSL客户端认证
凭借客户端证书认证，服务端来确认是否是可信的客户端。  
1. 接收请求后，服务端会发送Certificate Request报文，要求客户端提供证书
2. 用户将客户端证书以Client Certificate报文方式发给服务端
3. 服务端验证证书  
多数情况下， SSL客户端认证不只依靠证书进行认证，一般会和基于表单验证组成双因素验证来使用。

## 8.5 基于表单认证
客户端会向服务端的Web应用程序发送登陆信息来验证，如登陆电子邮件的过程。
### 8.5.1 认证多半为表单认证
### 8.5.2 Session管理及Cookie应用
一般会用Cookie来管理Session，以弥补HTTP无状态协议的缺点。  

# 9 基于HTTP的功能追加协议
## 9.1 基于HTTP的协议
为解决HTTP功能上、性能上的不足，在HTTP的基础上，建立了一些新协议。
## 9.2 SPDY
旨在解决性能瓶颈，缩短页面加载时间。
### 9.2.1 HTTP瓶颈
当Web会在很短的时间内发生大量更新时（如Facebook），HTTP需要频繁地从客户端到服务端确认有无更新，若没有更新，则这个请求是徒劳的。
#### Ajax
Ajax是一种达到局部页面加载的异步通信手段，由于只更新一部分页面，所以通信的数据量明显地减少了，但仍可能产生大量请求。
#### Comet
Comet会保留响应，直到服务端产生请求后才返回响应，虽然做到了实时更新，但每次连接的时间变长了。
### 9.2.2 SPDY
SPDY在HTTP应用层和SSL表示层间引入了SPDY会话层，使用SPDY后，HTTP会获得以下功能：  
 - 多路复用：同一个TCP连接，可以处理多个请求
 - 赋予请求优先级
 - 压缩HTTP首部
 - 推送功能：服务器主动向客户端发送数据
 - 服务器提示功能
# 9.3 使用浏览器进行全双工通信的WebSocket
一旦客户端和浏览器建立起WebSocket通信，任意一方都可直接发送报文。
